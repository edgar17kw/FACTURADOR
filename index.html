@author: Edgar Daniel González Soto


<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Facturas y Cotizaciones - Edgar's Solutions</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f4f4f4;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .nav-tabs {
            display: flex;
            background: #34495e;
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
            border: none;
            font-size: 16px;
        }
        
        .nav-tab:hover {
            background: #2c3e50;
        }
        
        .nav-tab.active {
            background: #3498db;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-section {
            padding: 30px;
        }
        
        .section-title {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .logo-upload {
            border: 2px dashed #3498db;
            padding: 20px;
            text-align: center;
            border-radius: 5px;
            background: #f8f9fa;
            margin-bottom: 15px;
        }
        
        .logo-preview {
            max-width: 150px;
            max-height: 80px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .services-section {
            margin: 20px 0;
        }
        
        .service-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            align-items: center;
        }
        
        .service-item input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        .service-description {
            flex: 3;
        }
        
        .service-price {
            flex: 1;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #219a52;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .total-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .total-amount {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
            text-align: right;
        }
        
        .actions {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .document-preview {
            display: none;
            margin-top: 30px;
            padding: 40px;
            background: white;
            border: 1px solid #ddd;
            position: relative;
            min-height: 800px;
        }
        
        .document-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .document-logo {
            max-width: 160px;
            max-height: 110px;
        }
        
        .company-name {
            font-size: 2.8em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
            text-align: center;
            width: 100%
        }
        
        .document-title {
            font-size: 2em;
            color: #3498db;
            margin: 20px 0;
            text-align: center;
        }
        
        .document-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        
        .client-info, .document-details {
            flex: 1;
        }
        
        .document-details {
            text-align: right;
        }
        
        .services-table {
            width: 100%;
            border-collapse: collapse;
            margin: 30px 0;
        }
        
        .services-table th, .services-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        .services-table th {
            background: #3498db;
            color: white;
        }
        
        .services-table .price {
            text-align: right;
        }
        
        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            opacity: 0.3;
            z-index: 0;
            font-size: 4em;
            color: #3498db;
            pointer-events: none;
            font-weight: bold;
        }
        
        .watermark img {
            width: 400px;
            height: auto;
            opacity: 0.3;
        }
        
        .watermark-text {
            font-size: 3em;
            font-weight: bold;
            color: #3498db;
            opacity: 0.3;
        }
        
        .document-content {
            position: relative;
            z-index: 1;
        }
        
        .quote-validity {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }
        
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                border-radius: 0;
            }
            
            .nav-tabs, .form-section, .actions {
                display: none;
            }
            
            .document-preview {
                display: block !important;
                padding: 20px;
                margin: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Edgar's Solutions</h1>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('invoice')">Facturas</button>
            <button class="nav-tab" onclick="switchTab('quote')">Cotizaciones</button>
        </div>
        
        <div id="invoiceTab" class="tab-content active">
            <div class="form-section">
                <div class="section-title">Logo de la Empresa</div>
                <div class="logo-upload">
                    <input type="file" id="logoInputInvoice" accept="image/*" style="display: none;">
                    <button class="btn btn-primary" onclick="document.getElementById('logoInputInvoice').click()">
                        Seleccionar Logo
                    </button>
                    <p>Formatos soportados: JPG, PNG, GIF</p>
                    <img id="logoPreviewInvoice" class="logo-preview" style="display: none;">
                </div>
                
                <div class="section-title">Informaci√≥n del Cliente</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="clientNameInvoice">Nombre del Cliente</label>
                        <input type="text" id="clientNameInvoice" placeholder="Nombre completo">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="clientAddressInvoice">Direcci√≥n</label>
                        <textarea id="clientAddressInvoice" rows="3" placeholder="Direcci√≥n completa del cliente"></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="clientPhoneInvoice">Tel√©fono</label>
                        <input type="tel" id="clientPhoneInvoice" placeholder="(000) 000-0000">
                    </div>
                </div>
                
                <div class="section-title">Fechas</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="issueDateInvoice">Fecha de Emisi√≥n</label>
                        <input type="date" id="issueDateInvoice">
                    </div>
                    <div class="form-group">
                        <label for="dueDateInvoice">Fecha de Vencimiento</label>
                        <input type="date" id="dueDateInvoice">
                    </div>
                </div>
                
                <div class="section-title">Servicios Prestados</div>
                <div class="services-section" id="servicesContainerInvoice">
                    <div class="service-item">
                        <input type="text" class="service-description" placeholder="Descripci√≥n del servicio">
                        <input type="number" class="service-price" placeholder="0.00" step="0.01" min="0">
                        <button class="btn btn-danger" onclick="removeService(this, 'invoice')">Eliminar</button>
                    </div>
                </div>
                <button class="btn btn-success" onclick="addService('invoice')">A√±adir Servicio</button>
                
                <div class="total-section">
                    <div class="total-amount">
                        Total: $<span id="totalAmountInvoice">0.00</span>
                    </div>
                </div>
                
                <div class="section-title">Notas y T√©rminos</div>
                <div class="form-group">
                    <label for="notesInvoice">Notas</label>
                    <textarea id="notesInvoice" rows="3">Gracias por confiar en nuestros servicios. Para cualquier duda, no dude en comunicarse con nosotros.</textarea>
                </div>
                <div class="form-group">
                    <label for="termsInvoice">T√©rminos y Condiciones</label>
                    <textarea id="termsInvoice" rows="3">El pago debe realizarse en su totalidad antes de la fecha de vencimiento. Pasado este periodo, se aplicar√° un cargo por demora del 5% mensual sobre el saldo pendiente. Nos reservamos el derecho de suspender servicios por falta de pago. Todos los materiales y servicios est√°n garantizados por 30 d√≠as.</textarea>
                </div>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="generateDocument('invoice')">Generar Factura</button>
                    <button class="btn btn-success" onclick="downloadPDF('invoice')" id="downloadBtnInvoice" style="display: none;">Guardar como PDF</button>
                    <button class="btn btn-primary" onclick="newDocument('invoice')" id="newInvoiceBtn" style="display: none;">Nueva Factura</button>
                </div>
            </div>
        </div>
        
        <div id="quoteTab" class="tab-content">
            <div class="form-section">
                <div class="section-title">Logo del negocio</div>
                <div class="logo-upload">
                    <input type="file" id="logoInputQuote" accept="image/*" style="display: none;">
                    <button class="btn btn-primary" onclick="document.getElementById('logoInputQuote').click()">
                        Seleccionar Logo
                    </button>
                    <p>Formatos soportados: JPG, PNG, GIF</p>
                    <img id="logoPreviewQuote" class="logo-preview" style="display: none;">
                </div>
                
                <div class="section-title">Informaci√≥n del Cliente</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="clientNameQuote">Nombre del Cliente</label>
                        <input type="text" id="clientNameQuote" placeholder="Nombre completo">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="clientAddressQuote">Direcci√≥n</label>
                        <textarea id="clientAddressQuote" rows="3" placeholder="Direcci√≥n completa del cliente"></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="clientPhoneQuote">Tel√©fono</label>
                        <input type="tel" id="clientPhoneQuote" placeholder="(000) 000-0000">
                    </div>
                </div>
                
                <div class="section-title">Fechas</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="issueDateQuote">Fecha de Emisi√≥n</label>
                        <input type="date" id="issueDateQuote">
                    </div>
                    <div class="form-group">
                        <label for="validityDays">D√≠as de Validez</label>
                        <input type="number" id="validityDays" value="10" min="1" placeholder="10">
                    </div>
                </div>
                
                <div class="section-title">Servicios Cotizados</div>
                <div class="services-section" id="servicesContainerQuote">
                    <div class="service-item">
                        <input type="text" class="service-description" placeholder="Descripci√≥n del servicio">
                        <input type="number" class="service-price" placeholder="0.00" step="0.01" min="0">
                        <button class="btn btn-danger" onclick="removeService(this, 'quote')">Eliminar</button>
                    </div>
                </div>
                <button class="btn btn-success" onclick="addService('quote')">A√±adir Servicio</button>
                
                <div class="total-section">
                    <div class="total-amount">
                        Total: $<span id="totalAmountQuote">0.00</span>
                    </div>
                </div>
                
                <div class="section-title">Notas y T√©rminos</div>
                <div class="form-group">
                    <label for="notesQuote">Notas</label>
                    <textarea id="notesQuote" rows="3">Esta cotizaci√≥n es v√°lida para los productos y servicios descritos. Los precios est√°n sujetos a cambios sin previo aviso si no se confirma dentro del periodo de validez.</textarea>
                </div>
                <div class="form-group">
                    <label for="termsQuote">T√©rminos y Condiciones</label>
                    <textarea id="termsQuote" rows="3">La cotizaci√≥n es v√°lida por 10 d√≠as a partir de la fecha de emisi√≥n. La disponibilidad de materiales y precios puede variar despu√©s de este periodo. Se requiere un deposito inicial del 50% del total. La aceptaci√≥n de esta cotizaci√≥n implica la conformidad con los t√©rminos establecidos.</textarea>
                </div>
                
                <div class="actions">
                    <button class="btn btn-warning" onclick="generateDocument('quote')">Generar Cotizaci√≥n</button>
                    <button class="btn btn-success" onclick="downloadPDF('quote')" id="downloadBtnQuote" style="display: none;">Guardar como PDF</button>
                    <button class="btn btn-warning" onclick="newDocument('quote')" id="newQuoteBtn" style="display: none;">Nueva Cotizaci√≥n</button>
                    <button class="btn btn-primary" onclick="convertToInvoice()" id="convertBtnQuote" style="display: none;">Convertir a Factura</button>
                </div>
            </div>
        </div>
        
        <div class="document-preview" id="documentPreview">
            <div class="watermark" id="watermark">
                <img id="watermarkLogo" style="display: none;" alt="Logo marca de agua">
                <span id="watermarkText" class="watermark-text">EDGAR'S SOLUTIONS</span>
            </div>
            
            <div class="document-content">
                <div class="document-header">
                    <img id="documentLogo" class="document-logo" style="display: none;">
                    <div class="company-info">
                        <div class="company-name">Edgar's Solutions</div>
                    </div>
                </div>
                
                <div class="document-title" id="documentTitle">FACTURA</div>
                
                <div class="document-info">
                    <div class="client-info">
                        <h3 id="clientInfoTitle">Facturar a:</h3>
                        <div id="displayClientName"></div>
                        <div id="displayClientAddress"></div>
                        <div id="displayClientPhone"></div>
                    </div>
                    <div class="document-details">
                        <div><strong>Fecha de Emisi√≥n:</strong> <span id="displayIssueDate"></span></div>
                        <div id="dueDateRow"><strong>Fecha de Vencimiento:</strong> <span id="displayDueDate"></span></div>
                        <div id="validityRow" style="display: none;"><strong>V√°lida hasta:</strong> <span id="displayValidityDate"></span></div>
                        <div><strong id="documentNumberLabel">Factura #:</strong> <span id="documentNumber"></span></div>
                    </div>
                </div>
                
                <div id="quoteValidityNotice" class="quote-validity" style="display: none;">
                    <strong>Esta cotizaci√≥n es v√°lida por <span id="validityDaysDisplay"></span> d√≠as a partir de la fecha de emisi√≥n.</strong>
                </div>
                
                <table class="services-table">
                    <thead>
                        <tr>
                            <th>Descripci√≥n</th>
                            <th>Precio</th>
                        </tr>
                    </thead>
                    <tbody id="servicesTableBody">
                    </tbody>
                </table>
                
                <div class="total-section">
                    <div class="total-amount">
                        <strong>Total: $<span id="displayTotal">0.00</span></strong>
                    </div>
                </div>
                
                <div id="displayNotes" style="margin-top: 30px;"></div>
                <div id="displayTerms" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>
    
    <script>
        let logoDataUrl = { invoice: null, quote: null };
        let currentDocumentType = null;
        
        // --- NUEVAS FUNCIONES PARA GENERAR N√öMERO DE DOCUMENTO ---
        // Almacenar el √∫ltimo contador en localStorage
        const COUNTER_KEY = 'dailyDocumentCounter';

        function getTodayKey() {
            const today = new Date();
            // Formato YYYY-MM-DD para la clave
            return `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
        }

        function getDailyCounter() {
            const todayKey = getTodayKey();
            let counters = JSON.parse(localStorage.getItem(COUNTER_KEY) || '{}');

            if (counters[todayKey] === undefined) {
                // Si es un nuevo d√≠a o nunca se ha usado hoy, inicializar a 0
                counters = {}; // Limpiar contadores de d√≠as anteriores si no quieres guardarlos
                counters[todayKey] = 0;
            }

            // Incrementar el contador para el d√≠a actual
            counters[todayKey]++;
            
            // Validar l√≠mite de 99
            if (counters[todayKey] > 99) {
                console.warn(`Advertencia: Se super√≥ el l√≠mite de 99 documentos para el d√≠a ${todayKey}. El contador se ha reiniciado a 1 para el pr√≥ximo.`);
                counters[todayKey] = 1; // Reiniciar para el pr√≥ximo documento si se supera
            }

            localStorage.setItem(COUNTER_KEY, JSON.stringify(counters));
            return counters[todayKey];
        }

        function getFormattedDatePart() {
            const now = new Date();
            const month = now.getMonth() + 1; // getMonth() es 0-indexado
            const day = now.getDate();

            let codeMonth;
            if (month >= 1 && month <= 9) {
                codeMonth = String(month);
            } else if (month === 10) {
                codeMonth = 'A';
            } else if (month === 11) {
                codeMonth = 'B';
            } else if (month === 12) {
                codeMonth = 'C';
            }
            
            const codeDay = String(day).padStart(2, '0');

            return { codeMonth, codeDay };
        }

        function generateDocumentNumber(type) {
            const { codeMonth, codeDay } = getFormattedDatePart();
            const counter = getDailyCounter();
            const codeCounter = String(counter).padStart(2, '0');

            const numeroFinal = `${codeMonth}${codeDay}${codeCounter}`;
            return numeroFinal;
        }
        // --- FIN DE NUEVAS FUNCIONES ---

        // Configurar fechas actuales por defecto
        function initializeDates() {
            const today = new Date();
            document.getElementById('issueDateInvoice').valueAsDate = today;
            document.getElementById('issueDateQuote').valueAsDate = today;
            
            const invoiceDueDate = new Date();
            invoiceDueDate.setDate(invoiceDueDate.getDate() + 30);
            document.getElementById('dueDateInvoice').valueAsDate = invoiceDueDate;
        }
        
        // Cambiar entre pesta√±as
        function switchTab(type) {
            // Actualizar pesta√±as
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${type}')"]`).classList.add('active');
            
            // Mostrar contenido correspondiente
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(type + 'Tab').classList.add('active');
            
            // Ocultar preview si est√° visible
            document.getElementById('documentPreview').style.display = 'none';

            // Reset buttons visibility
            document.getElementById('downloadBtnInvoice').style.display = 'none';
            document.getElementById('newInvoiceBtn').style.display = 'none';
            document.getElementById('downloadBtnQuote').style.display = 'none';
            document.getElementById('newQuoteBtn').style.display = 'none';
            document.getElementById('convertBtnQuote').style.display = 'none';
        }
        
        // Manejar la carga del logo
        function setupLogoHandler(type) {
            document.getElementById(`logoInput${type.charAt(0).toUpperCase() + type.slice(1)}`).addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        logoDataUrl[type] = e.target.result;
                        document.getElementById(`logoPreview${type.charAt(0).toUpperCase() + type.slice(1)}`).src = logoDataUrl[type];
                        document.getElementById(`logoPreview${type.charAt(0).toUpperCase() + type.slice(1)}`).style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // Funci√≥n para a√±adir servicio
        function addService(type) {
            const container = document.getElementById(`servicesContainer${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const serviceItem = document.createElement('div');
            serviceItem.className = 'service-item';
            serviceItem.innerHTML = `
                <input type="text" class="service-description" placeholder="Descripci√≥n del servicio">
                <input type="number" class="service-price" placeholder="0.00" step="0.01" min="0">
                <button class="btn btn-danger" onclick="removeService(this, '${type}')">Eliminar</button>
            `;
            container.appendChild(serviceItem);
            
            // A√±adir event listener para el c√°lculo autom√°tico
            const priceInput = serviceItem.querySelector('.service-price');
            priceInput.addEventListener('input', () => calculateTotal(type));
            calculateTotal(type); // Recalcular al a√±adir un nuevo servicio
        }
        
        // Funci√≥n para eliminar servicio
        function removeService(button, type) {
            const container = document.getElementById(`servicesContainer${type.charAt(0).toUpperCase() + type.slice(1)}`);
            if (container.children.length > 1) { // Asegura que al menos un servicio quede
                button.parentElement.remove();
                calculateTotal(type);
            }
        }
        
        // Calcular total autom√°ticamente
        function calculateTotal(type) {
            const priceInputs = document.querySelectorAll(`#servicesContainer${type.charAt(0).toUpperCase() + type.slice(1)} .service-price`);
            let total = 0;
            
            priceInputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                total += value;
            });
            
            document.getElementById(`totalAmount${type.charAt(0).toUpperCase() + type.slice(1)}`).textContent = total.toFixed(2);
        }
        
        // Funci√≥n para generar el documento
        function generateDocument(type) {
            currentDocumentType = type;
            const typeCapitalized = type.charAt(0).toUpperCase() + type.slice(1);
            
            // Validar campos requeridos
            const clientName = document.getElementById(`clientName${typeCapitalized}`).value.trim();
            if (!clientName) {
                alert('Por favor, ingrese el nombre del cliente.');
                return;
            }
            
            // Generar n√∫mero de documento usando la nueva l√≥gica
            document.getElementById('documentNumber').textContent = generateDocumentNumber(type);
            
            // Configurar t√≠tulos seg√∫n el tipo
            if (type === 'invoice') {
                document.getElementById('documentTitle').textContent = 'FACTURA';
                document.getElementById('clientInfoTitle').textContent = 'Facturar a:';
                document.getElementById('documentNumberLabel').textContent = 'Factura #:';
                document.getElementById('dueDateRow').style.display = 'block';
                document.getElementById('validityRow').style.display = 'none';
                document.getElementById('quoteValidityNotice').style.display = 'none';
            } else { // type === 'quote'
                document.getElementById('documentTitle').textContent = 'COTIZACI√ìN';
                document.getElementById('clientInfoTitle').textContent = 'Cotizar para:';
                document.getElementById('documentNumberLabel').textContent = 'Cotizaci√≥n #:';
                document.getElementById('dueDateRow').style.display = 'none';
                document.getElementById('validityRow').style.display = 'block';
                document.getElementById('quoteValidityNotice').style.display = 'block';
                
                // Calcular fecha de validez
                const issueDate = new Date(document.getElementById(`issueDate${typeCapitalized}`).value);
                const validityDays = parseInt(document.getElementById('validityDays').value) || 10; // Default to 10 for quotes
                const validityDate = new Date(issueDate);
                validityDate.setDate(validityDate.getDate() + validityDays);
                document.getElementById('displayValidityDate').textContent = validityDate.toLocaleDateString('es-ES');
                document.getElementById('validityDaysDisplay').textContent = validityDays;
            }
            
            // Mostrar logo si existe
            if (logoDataUrl[type]) {
                document.getElementById('documentLogo').src = logoDataUrl[type];
                document.getElementById('documentLogo').style.display = 'block';
                document.getElementById('watermarkLogo').src = logoDataUrl[type];
                document.getElementById('watermarkLogo').style.display = 'block';
                document.getElementById('watermarkText').style.display = 'none';
            } else {
                document.getElementById('documentLogo').style.display = 'none';
                document.getElementById('watermarkLogo').style.display = 'none';
                document.getElementById('watermarkText').style.display = 'block';
            }
            
            // Informaci√≥n del cliente
            document.getElementById('displayClientName').textContent = clientName;
            document.getElementById('displayClientAddress').textContent = document.getElementById(`clientAddress${typeCapitalized}`).value;
            document.getElementById('displayClientPhone').textContent = document.getElementById(`clientPhone${typeCapitalized}`).value;
            
            // Fechas
            const issueDate = new Date(document.getElementById(`issueDate${typeCapitalized}`).value);
            document.getElementById('displayIssueDate').textContent = issueDate.toLocaleDateString('es-ES');
            
            if (type === 'invoice') {
                const dueDate = new Date(document.getElementById(`dueDate${typeCapitalized}`).value);
                document.getElementById('displayDueDate').textContent = dueDate.toLocaleDateString('es-ES');
            }
            
            // Servicios
            const servicesTableBody = document.getElementById('servicesTableBody');
            servicesTableBody.innerHTML = ''; // Limpiar servicios anteriores
            
            const serviceItems = document.querySelectorAll(`#servicesContainer${typeCapitalized} .service-item`);
            let totalForDisplay = 0;

            serviceItems.forEach(item => {
                const description = item.querySelector('.service-description').value;
                const price = parseFloat(item.querySelector('.service-price').value) || 0;
                
                const row = servicesTableBody.insertRow();
                const descCell = row.insertCell(0);
                const priceCell = row.insertCell(1);
                
                descCell.textContent = description;
                priceCell.textContent = price.toFixed(2);
                priceCell.classList.add('price'); // A√±adir clase para estilo de alineaci√≥n
                totalForDisplay += price;
            });

            document.getElementById('displayTotal').textContent = totalForDisplay.toFixed(2);
            
            // Notas y T√©rminos
            document.getElementById('displayNotes').innerHTML = `<strong>Notas:</strong><br>${document.getElementById(`notes${typeCapitalized}`).value.replace(/\n/g, '<br>')}`;
            document.getElementById('displayTerms').innerHTML = `<strong>T√©rminos y Condiciones:</strong><br>${document.getElementById(`terms${typeCapitalized}`).value.replace(/\n/g, '<br>')}`;
            
            // Mostrar la vista previa y los botones de acci√≥n
            document.getElementById('documentPreview').style.display = 'block';
            document.getElementById(`downloadBtn${typeCapitalized}`).style.display = 'inline-block';
            document.getElementById(`new${typeCapitalized}Btn`).style.display = 'inline-block';
            
            // Mostrar bot√≥n de convertir a factura solo si es una cotizaci√≥n
            if (type === 'quote') {
                document.getElementById('convertBtnQuote').style.display = 'inline-block';
            } else {
                document.getElementById('convertBtnQuote').style.display = 'none';
            }
        }

        // Funci√≥n para descargar PDF
        function downloadPDF(type) {
            const element = document.getElementById('documentPreview');
            const docTitle = document.getElementById('documentTitle').textContent;
            const docNumber = document.getElementById('documentNumber').textContent;
            
            // Esconder los botones antes de generar el PDF para que no aparezcan en la captura
            const downloadBtn = document.getElementById(`downloadBtn${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const newBtn = document.getElementById(`new${type.charAt(0).toUpperCase() + type.slice(1)}Btn`);
            const convertBtn = document.getElementById('convertBtnQuote');

            if (downloadBtn) downloadBtn.style.display = 'none';
            if (newBtn) newBtn.style.display = 'none';
            if (convertBtn) convertBtn.style.display = 'none';

            html2canvas(element, { scale: 2, useCORS: true }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210; 
                const pageHeight = 297; 
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                pdf.save(`${docTitle.toLowerCase()}-${docNumber}.pdf`);

                // Restaurar la visibilidad de los botones despu√©s de generar el PDF
                if (downloadBtn) downloadBtn.style.display = 'inline-block';
                if (newBtn) newBtn.style.display = 'inline-block';
                if (type === 'quote' && convertBtn) convertBtn.style.display = 'inline-block';
            });
        }

        // Funci√≥n para empezar un nuevo documento (borrar campos)
        function newDocument(type) {
            const typeCapitalized = type.charAt(0).toUpperCase() + type.slice(1);
            
            document.getElementById(`clientName${typeCapitalized}`).value = '';
            document.getElementById(`clientAddress${typeCapitalized}`).value = '';
            document.getElementById(`clientPhone${typeCapitalized}`).value = '';
            document.getElementById(`notes${typeCapitalized}`).value = '';
            document.getElementById(`terms${typeCapitalized}`).value = '';
            document.getElementById(`logoInput${typeCapitalized}`).value = '';
            logoDataUrl[type] = null;
            document.getElementById(`logoPreview${typeCapitalized}`).style.display = 'none';
            document.getElementById(`logoPreview${typeCapitalized}`).src = '';

            // Reset services
            const servicesContainer = document.getElementById(`servicesContainer${typeCapitalized}`);
            servicesContainer.innerHTML = `
                <div class="service-item">
                    <input type="text" class="service-description" placeholder="Descripci√≥n del servicio">
                    <input type="number" class="service-price" placeholder="0.00" step="0.01" min="0">
                    <button class="btn btn-danger" onclick="removeService(this, '${type}')">Eliminar</button>
                </div>
            `;
            // Add event listener for the newly added service item
            servicesContainer.querySelector('.service-price').addEventListener('input', () => calculateTotal(type));

            calculateTotal(type); // Reset total
            initializeDates(); // Reset dates

            document.getElementById('documentPreview').style.display = 'none';
            document.getElementById(`downloadBtn${typeCapitalized}`).style.display = 'none';
            document.getElementById(`new${typeCapitalized}Btn`).style.display = 'none';
            if (type === 'quote') {
                document.getElementById('convertBtnQuote').style.display = 'none';
            }
        }

        // Funci√≥n para convertir cotizaci√≥n a factura
        function convertToInvoice() {
            // Transferir datos de cotizaci√≥n a factura
            document.getElementById('clientNameInvoice').value = document.getElementById('clientNameQuote').value;
            document.getElementById('clientAddressInvoice').value = document.getElementById('clientAddressQuote').value;
            document.getElementById('clientPhoneInvoice').value = document.getElementById('clientPhoneQuote').value;
            document.getElementById('issueDateInvoice').value = document.getElementById('issueDateQuote').value;
            // La fecha de vencimiento de la factura se establecer√° por defecto al cambiar a factura o se puede calcular
            initializeDates(); // Recalcular fecha de vencimiento para la factura

            document.getElementById('notesInvoice').value = document.getElementById('notesQuote').value;
            document.getElementById('termsInvoice').value = document.getElementById('termsQuote').value;

            // Transferir logo
            logoDataUrl['invoice'] = logoDataUrl['quote'];
            document.getElementById('logoPreviewInvoice').src = logoDataUrl['invoice'];
            if (logoDataUrl['invoice']) {
                document.getElementById('logoPreviewInvoice').style.display = 'block';
            } else {
                document.getElementById('logoPreviewInvoice').style.display = 'none';
            }
            
            // Transferir servicios
            const servicesContainerInvoice = document.getElementById('servicesContainerInvoice');
            servicesContainerInvoice.innerHTML = '';
            document.querySelectorAll('#servicesContainerQuote .service-item').forEach(item => {
                const description = item.querySelector('.service-description').value;
                const price = item.querySelector('.service-price').value;
                
                const serviceItem = document.createElement('div');
                serviceItem.className = 'service-item';
                serviceItem.innerHTML = `
                    <input type="text" class="service-description" placeholder="Descripci√≥n del servicio" value="${description}">
                    <input type="number" class="service-price" placeholder="0.00" step="0.01" min="0" value="${price}">
                    <button class="btn btn-danger" onclick="removeService(this, 'invoice')">Eliminar</button>
                `;
                servicesContainerInvoice.appendChild(serviceItem);
                serviceItem.querySelector('.service-price').addEventListener('input', () => calculateTotal('invoice'));
            });
            calculateTotal('invoice');

            // Cambiar a la pesta√±a de factura y generar el documento
            switchTab('invoice');
            generateDocument('invoice');
        }

        // Inicializar listeners y fechas al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            initializeDates();
            setupLogoHandler('invoice');
            setupLogoHandler('quote');

            // Add event listeners for initial service items for both tabs
            document.querySelectorAll('#servicesContainerInvoice .service-price').forEach(input => {
                input.addEventListener('input', () => calculateTotal('invoice'));
            });
            document.querySelectorAll('#servicesContainerQuote .service-price').forEach(input => {
                input.addEventListener('input', () => calculateTotal('quote'));
            });

            // Calculate initial totals
            calculateTotal('invoice');
            calculateTotal('quote');
        });
    </script>
</body>
</html>
