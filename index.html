# -*- coding: utf-8 -*-
"""
Created on Fri Jul  4 01:17:55 2025

@author: Edgar Daniel Gonzalez Soto
"""

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Facturas y Cotizaciones - Edgar's Solutions</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /*
        *********************************************************
        * ESTILOS CSS - NO TOCAR SI NO SABES       *
        *********************************************************
        */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f4f4f4;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .nav-tabs {
            display: flex;
            background: #34495e;
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
            border: none;
            font-size: 16px;
        }
        
        .nav-tab:hover {
            background: #2c3e50;
        }
        
        .nav-tab.active {
            background: #3498db;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-section {
            padding: 30px;
        }
        
        .section-title {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .logo-upload {
            border: 2px dashed #3498db;
            padding: 20px;
            text-align: center;
            border-radius: 5px;
            background: #f8f9fa;
            margin-bottom: 15px;
        }
        
        .logo-preview {
            max-width: 150px;
            max-height: 80px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .services-section {
            margin: 20px 0;
        }
        
        .service-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            align-items: center;
        }
        
        .service-item input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        .service-description {
            flex: 3;
        }
        
        .service-price {
            flex: 1;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #219a52;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .total-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .total-amount {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
            text-align: right;
        }
        
        .actions {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .document-preview {
            display: none;
            margin-top: 30px;
            padding: 40px;
            background: white;
            border: 1px solid #ddd;
            position: relative;
            min-height: 800px;
        }
        
        .document-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .document-logo {
            max-width: 160px;
            max-height: 110px;
        }
        
        .company-name {
            font-size: 2.8em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
            text-align: center;
            width: 100%
        }
        
        .document-title {
            font-size: 2em;
            color: #3498db;
            margin: 20px 0;
            text-align: center;
        }
        
        .document-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        
        .client-info, .document-details {
            flex: 1;
        }
        
        .document-details {
            text-align: right;
        }
        
        .services-table {
            width: 100%;
            border-collapse: collapse;
            margin: 30px 0;
        }
        
        .services-table th, .services-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        .services-table th {
            background: #3498db;
            color: white;
        }
        
        .services-table .price {
            text-align: right;
        }
        
        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            opacity: 0.3;
            z-index: 0;
            font-size: 4em;
            color: #3498db;
            pointer-events: none;
            font-weight: bold;
        }
        
        .watermark img {
            width: 400px;
            height: auto;
            opacity: 0.3;
        }
        
        .watermark-text {
            font-size: 3em;
            font-weight: bold;
            color: #3498db;
            opacity: 0.3;
        }
        
        .document-content {
            position: relative;
            z-index: 1;
        }
        
        .quote-validity {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }
        
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                border-radius: 0;
            }
            
            .nav-tabs, .form-section, .actions {
                display: none;
            }
            
            .document-preview {
                display: block !important;
                padding: 20px;
                margin: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Edgar's Solutions</h1>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('invoice')">Facturas</button>
            <button class="nav-tab" onclick="switchTab('quote')">Cotizaciones</button>
        </div>
        
        <div id="invoiceTab" class="tab-content active">
            <div class="form-section">
                <div class="section-title">Logo de la Empresa</div>
                <div class="logo-upload">
                    <input type="file" id="logoInputInvoice" accept="image/*" style="display: none;">
                    <button class="btn btn-primary" onclick="document.getElementById('logoInputInvoice').click()">
                        Seleccionar Logo
                    </button>
                    <p>Formatos soportados: JPG, PNG, GIF</p>
                    <img id="logoPreviewInvoice" class="logo-preview" style="display: none;">
                </div>
                
                <div class="section-title">Información del Cliente</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="clientNameInvoice">Nombre del Cliente</label>
                        <input type="text" id="clientNameInvoice" placeholder="Nombre completo">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="clientAddressInvoice">Dirección</label>
                        <textarea id="clientAddressInvoice" rows="3" placeholder="Dirección completa del cliente"></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="clientPhoneInvoice">Teléfono</label>
                        <input type="tel" id="clientPhoneInvoice" placeholder="(000) 000-0000" maxlength="14">
                    </div>
                </div>
                
                <div class="section-title">Fechas</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="issueDateInvoice">Fecha de Emisión</label>
                        <input type="date" id="issueDateInvoice">
                    </div>
                    <div class="form-group">
                        <label for="dueDateInvoice">Fecha de Vencimiento</label>
                        <input type="date" id="dueDateInvoice">
                    </div>
                </div>
                
                <div class="section-title">Servicios Prestados</div>
                <div class="services-section" id="servicesContainerInvoice">
                    <div class="service-item">
                        <input type="text" class="service-description" placeholder="Descripción del servicio">
                        <input type="number" class="service-price" placeholder="0.00" step="0.01" min="0">
                        <button class="btn btn-danger" onclick="removeService(this, 'invoice')">Eliminar</button>
                    </div>
                </div>
                <button class="btn btn-success" onclick="addService('invoice')">Añadir Servicio</button>
                
                <div class="total-section">
                    <div class="total-amount">
                        Total: $<span id="totalAmountInvoice">0.00</span>
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="generateDocument('invoice')">Generar Factura</button>
                    <button class="btn btn-success" onclick="downloadPDF('invoice')" id="downloadBtnInvoice" style="display: none;">Guardar como PDF</button>
                    <button class="btn btn-primary" onclick="newDocument('invoice')" id="newInvoiceBtn" style="display: none;">Nueva Factura</button>
                </div>
            </div>
        </div>
        
        <div id="quoteTab" class="tab-content">
            <div class="form-section">
                <div class="section-title">Logo de la Empresa</div>
                <div class="logo-upload">
                    <input type="file" id="logoInputQuote" accept="image/*" style="display: none;">
                    <button class="btn btn-primary" onclick="document.getElementById('logoInputQuote').click()">
                        Seleccionar Logo
                    </button>
                    <p>Formatos soportados: JPG, PNG, GIF</p>
                    <img id="logoPreviewQuote" class="logo-preview" style="display: none;">
                </div>
                
                <div class="section-title">Información del Cliente</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="clientNameQuote">Nombre del Cliente</label>
                        <input type="text" id="clientNameQuote" placeholder="Nombre completo">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="clientAddressQuote">Dirección</label>
                        <textarea id="clientAddressQuote" rows="3" placeholder="Dirección completa del cliente"></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="clientPhoneQuote">Teléfono</label>
                        <input type="tel" id="clientPhoneQuote" placeholder="(000) 000-0000" maxlength="14">
                    </div>
                </div>
                
                <div class="section-title">Fechas</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="issueDateQuote">Fecha de Emisión</label>
                        <input type="date" id="issueDateQuote">
                    </div>
                    <div class="form-group">
                        <label for="validityDays">Días de Validez</label>
                        <input type="number" id="validityDays" value="10" min="1" placeholder="10">
                    </div>
                </div>
                
                <div class="section-title">Servicios Cotizados</div>
                <div class="services-section" id="servicesContainerQuote">
                    <div class="service-item">
                        <input type="text" class="service-description" placeholder="Descripción del servicio">
                        <input type="number" class="service-price" placeholder="0.00" step="0.01" min="0">
                        <button class="btn btn-danger" onclick="removeService(this, 'quote')">Eliminar</button>
                    </div>
                </div>
                <button class="btn btn-success" onclick="addService('quote')">Añadir Servicio</button>
                
                <div class="total-section">
                    <div class="total-amount">
                        Total: $<span id="totalAmountQuote">0.00</span>
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn btn-warning" onclick="generateDocument('quote')">Generar Cotización</button>
                    <button class="btn btn-success" onclick="downloadPDF('quote')" id="downloadBtnQuote" style="display: none;">Guardar como PDF</button>
                    <button class="btn btn-warning" onclick="newDocument('quote')" id="newQuoteBtn" style="display: none;">Nueva Cotización</button>
                    <button class="btn btn-primary" onclick="convertToInvoice()" id="convertBtnQuote" style="display: none;">Convertir a Factura</button>
                </div>
            </div>
        </div>
        
        <div class="document-preview" id="documentPreview">
            <div class="watermark" id="watermark">
                <img id="watermarkLogo" style="display: none;" alt="Logo marca de agua">
                <span id="watermarkText" class="watermark-text">EDGAR'S SOLUTIONS</span>
            </div>
            
            <div class="document-content">
                <div class="document-header">
                    <img id="documentLogo" class="document-logo" style="display: none;">
                    <div class="company-info">
                        <div class="company-name">Edgar's Solutions</div>
                    </div>
                </div>
                
                <div class="document-title" id="documentTitle">FACTURA</div>
                
                <div class="document-info">
                    <div class="client-info">
                        <h3 id="clientInfoTitle">Facturar a:</h3>
                        <div id="displayClientName"></div>
                        <div id="displayClientAddress"></div>
                        <div id="displayClientPhone"></div>
                    </div>
                    <div class="document-details">
                        <div><strong>Fecha de Emisión:</strong> <span id="displayIssueDate"></span></div>
                        <div id="dueDateRow"><strong>Fecha de Vencimiento:</strong> <span id="displayDueDate"></span></div>
                        <div id="validityRow" style="display: none;"><strong>Válida hasta:</strong> <span id="displayValidityDate"></span></div>
                        <div><strong id="documentNumberLabel">Factura #:</strong> <span id="documentNumber"></span></div>
                    </div>
                </div>
                
                <div id="quoteValidityNotice" class="quote-validity" style="display: none;">
                    <strong>Esta cotización es válida por <span id="validityDaysDisplay"></span> días a partir de la fecha de emisión.</strong>
                </div>
                
                <table class="services-table">
                    <thead>
                        <tr>
                            <th>Descripción</th>
                            <th>Precio</th>
                        </tr>
                    </thead>
                    <tbody id="servicesTableBody">
                    </tbody>
                </table>
                
                <div class="total-section">
                    <div class="total-amount">
                        <strong>Total: $<span id="displayTotal">0.00</span></strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        /*
        *********************************************************
        * JAVASCRIPT - NO TOCAR SI NO SABES       *
        *********************************************************
        */

        // URL de tu Google Apps Script Web App
        // **** ¡IMPORTANTE! ACTUALIZA ESTA URL CON LA TUYA DESPUÉS DE DESPLEGAR EL SCRIPT DE APPS SCRIPT ****
        const GOOGLE_SHEETS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyjlAExE4jkDPsEU-CtkIRAw_s4ml2tERy63T9Se1DA-ouXPM_L4ox9v0lJORDs8JH9/exec';

        let logoDataUrl = { invoice: null, quote: null };
        let currentDocumentType = null;
        
        // --- FUNCIONES PARA GENERAR NÚMERO DE DOCUMENTO ---
        const COUNTER_KEY = 'dailyDocumentCounter';

        function getTodayKey() {
            const today = new Date();
            // Formato YYYY-MM-DD
            return `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
        }

        function getDailyCounter() {
            const todayKey = getTodayKey();
            let counters = JSON.parse(localStorage.getItem(COUNTER_KEY) || '{}');

            // Si es un nuevo día o el contador excede 99 (ej: 0-98, el 99 sería el #100 del día), reinicia o inicializa para hoy
            if (counters[todayKey] === undefined || counters[todayKey] >= 99) {
                // Borra contadores de días anteriores para mantener el localStorage limpio, opcional
                counters = {}; 
                counters[todayKey] = 0; // Se incrementará a 1 en la siguiente línea
            }

            counters[todayKey]++;
            
            localStorage.setItem(COUNTER_KEY, JSON.stringify(counters));
            return counters[todayKey];
        }

        function getFormattedDatePart() {
            const now = new Date();
            const month = now.getMonth() + 1; // getMonth() es base 0
            const day = now.getDate();

            let codeMonth;
            if (month >= 1 && month <= 9) {
                codeMonth = String(month);
            } else if (month === 10) {
                codeMonth = 'A';
            } else if (month === 11) {
                codeMonth = 'B';
            } else if (month === 12) {
                codeMonth = 'C';
            }
            
            const codeDay = String(day).padStart(2, '0'); // Asegura dos dígitos para el día

            return { codeMonth, codeDay };
        }

        function generateDocumentNumber(type) {
            const { codeMonth, codeDay } = getFormattedDatePart();
            const counter = getDailyCounter();
            const codeCounter = String(counter).padStart(2, '0'); // Asegura dos dígitos para el contador

            // Formato: MMDDXX (ejemplo: 70401 para Julio 4, documento #1)
            const numeroFinal = `${codeMonth}${codeDay}${codeCounter}`;
            return numeroFinal;
        }
        // --- FIN DE FUNCIONES PARA GENERAR NÚMERO DE DOCUMENTO ---

        // Función para formatear el número de teléfono
        function formatPhoneNumber(input) {
            let value = input.value.replace(/\D/g, ''); // Elimina cualquier cosa que no sea un dígito

            if (value.length > 10) { // Limita a 10 dígitos para el formato (000) 000-0000
                value = value.substring(0, 10);
            }

            let formattedValue = '';
            if (value.length > 0) {
                formattedValue = '(' + value.substring(0, 3);
            }
            if (value.length >= 4) {
                formattedValue += ') ' + value.substring(3, 6);
            }
            if (value.length >= 7) {
                formattedValue += '-' + value.substring(6, 10);
            }
            input.value = formattedValue;
        }
        
        // Configurar fechas actuales por defecto
        function initializeDates() {
            const today = new Date();
            // Establecer fecha de emisión a hoy
            document.getElementById('issueDateInvoice').valueAsDate = today;
            document.getElementById('issueDateQuote').valueAsDate = today;
            
            // Establecer fecha de vencimiento (para facturas) a 30 días desde hoy
            const invoiceDueDate = new Date();
            invoiceDueDate.setDate(invoiceDueDate.getDate() + 30);
            document.getElementById('dueDateInvoice').valueAsDate = invoiceDueDate;
        }
        
        // Cambiar entre pestañas de Facturas y Cotizaciones
        function switchTab(type) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${type}')"]`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(type + 'Tab').classList.add('active');
            
            // Ocultar previsualización y botones de acción al cambiar de pestaña
            document.getElementById('documentPreview').style.display = 'none';

            document.getElementById('downloadBtnInvoice').style.display = 'none';
            document.getElementById('newInvoiceBtn').style.display = 'none';
            document.getElementById('downloadBtnQuote').style.display = 'none';
            document.getElementById('newQuoteBtn').style.display = 'none';
            document.getElementById('convertBtnQuote').style.display = 'none';
        }
        
        // Manejar la carga del logo
        function setupLogoHandler(type) {
            document.getElementById(`logoInput${type.charAt(0).toUpperCase() + type.slice(1)}`).addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        logoDataUrl[type] = e.target.result;
                        document.getElementById(`logoPreview${type.charAt(0).toUpperCase() + type.slice(1)}`).src = logoDataUrl[type];
                        document.getElementById(`logoPreview${type.charAt(0).toUpperCase() + type.slice(1)}`).style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // Función para añadir un nuevo campo de servicio
        function addService(type) {
            const container = document.getElementById(`servicesContainer${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const serviceItem = document.createElement('div');
            serviceItem.className = 'service-item';
            serviceItem.innerHTML = `
                <input type="text" class="service-description" placeholder="Descripción del servicio">
                <input type="number" class="service-price" placeholder="0.00" step="0.01" min="0">
                <button class="btn btn-danger" onclick="removeService(this, '${type}')">Eliminar</button>
            `;
            container.appendChild(serviceItem);
            
            // Añadir listener para recalcular el total al cambiar este nuevo precio
            const priceInput = serviceItem.querySelector('.service-price');
            priceInput.addEventListener('input', () => calculateTotal(type));
            calculateTotal(type); // Recalcular total inmediatamente
        }
        
        // Función para eliminar un campo de servicio
        function removeService(button, type) {
            const container = document.getElementById(`servicesContainer${type.charAt(0).toUpperCase() + type.slice(1)}`);
            if (container.children.length > 1) { // Asegura que siempre haya al menos un campo de servicio
                button.parentElement.remove();
                calculateTotal(type); // Recalcular total después de eliminar
            }
        }
        
        // Calcular el total de los servicios automáticamente
        function calculateTotal(type) {
            const priceInputs = document.querySelectorAll(`#servicesContainer${type.charAt(0).toUpperCase() + type.slice(1)} .service-price`);
            let total = 0;
            
            priceInputs.forEach(input => {
                const value = parseFloat(input.value) || 0; // Asegura que sea un número
                total += value;
            });
            
            document.getElementById(`totalAmount${type.charAt(0).toUpperCase() + type.slice(1)}`).textContent = total.toFixed(2);
        }
        
        // Función principal para generar el documento y enviar a Google Sheets
        async function generateDocument(type) {
            currentDocumentType = type;
            const typeCapitalized = type.charAt(0).toUpperCase() + type.slice(1);
            
            // Validar que el nombre del cliente no esté vacío
            const clientName = document.getElementById(`clientName${typeCapitalized}`).value.trim();
            if (!clientName) {
                alert('Por favor, ingrese el nombre del cliente.');
                return;
            }
            
            // Generar número de documento único
            const documentNumber = generateDocumentNumber(type);
            document.getElementById('documentNumber').textContent = documentNumber;
            
            // Configuración específica para Factura o Cotización
            if (type === 'invoice') {
                document.getElementById('documentTitle').textContent = 'FACTURA';
                document.getElementById('clientInfoTitle').textContent = 'Facturar a:';
                document.getElementById('documentNumberLabel').textContent = 'Factura #:';
                document.getElementById('dueDateRow').style.display = 'block';
                document.getElementById('validityRow').style.display = 'none';
                document.getElementById('quoteValidityNotice').style.display = 'none';
            } else { // type === 'quote'
                document.getElementById('documentTitle').textContent = 'COTIZACIÓN';
                document.getElementById('clientInfoTitle').textContent = 'Cotizar para:';
                document.getElementById('documentNumberLabel').textContent = 'Cotización #:';
                document.getElementById('dueDateRow').style.display = 'none';
                document.getElementById('validityRow').style.display = 'block';
                document.getElementById('quoteValidityNotice').style.display = 'block';
                
                const issueDate = new Date(document.getElementById(`issueDate${typeCapitalized}`).value);
                const validityDays = parseInt(document.getElementById('validityDays').value) || 10;
                const validityDate = new Date(issueDate);
                validityDate.setDate(validityDate.getDate() + validityDays);
                document.getElementById('displayValidityDate').textContent = validityDate.toLocaleDateString('es-ES');
                document.getElementById('validityDaysDisplay').textContent = validityDays;
            }
            
            // Mostrar logo o marca de agua (texto)
            if (logoDataUrl[type]) {
                document.getElementById('documentLogo').src = logoDataUrl[type];
                document.getElementById('documentLogo').style.display = 'block';
                document.getElementById('watermarkLogo').src = logoDataUrl[type];
                document.getElementById('watermarkLogo').style.display = 'block';
                document.getElementById('watermarkText').style.display = 'none';
            } else {
                document.getElementById('documentLogo').style.display = 'none';
                document.getElementById('watermarkLogo').style.display = 'none';
                document.getElementById('watermarkText').style.display = 'block';
            }
            
            // Recopilar todos los datos del formulario
            const clientAddress = document.getElementById(`clientAddress${typeCapitalized}`).value;
            const clientPhone = document.getElementById(`clientPhone${typeCapitalized}`).value;
            const issueDate = document.getElementById(`issueDate${typeCapitalized}`).value;
            const dueDate = document.getElementById(`dueDate${typeCapitalized}`).value; // Solo para factura
            const totalAmount = parseFloat(document.getElementById(`totalAmount${typeCapitalized}`).textContent);

            // Actualizar la previsualización del documento
            document.getElementById('displayClientName').textContent = clientName;
            document.getElementById('displayClientAddress').textContent = clientAddress;
            document.getElementById('displayClientPhone').textContent = clientPhone; 

            document.getElementById('displayIssueDate').textContent = new Date(issueDate).toLocaleDateString('es-ES');
            if (type === 'invoice') {
                document.getElementById('displayDueDate').textContent = new Date(dueDate).toLocaleDateString('es-ES');
            }

            const servicesTableBody = document.getElementById('servicesTableBody');
            servicesTableBody.innerHTML = ''; 
            const serviceItems = document.querySelectorAll(`#servicesContainer${typeCapitalized} .service-item`);
            
            // Recopilar servicios para la visualización del PDF (no para el Sheet)
            serviceItems.forEach(item => {
                const description = item.querySelector('.service-description').value;
                const price = parseFloat(item.querySelector('.service-price').value) || 0;
                
                const row = servicesTableBody.insertRow();
                const descCell = row.insertCell(0);
                const priceCell = row.insertCell(1);
                descCell.textContent = description;
                priceCell.textContent = price.toFixed(2);
                priceCell.className = 'price';
            });

            document.getElementById('displayTotal').textContent = totalAmount.toFixed(2);

            // Mostrar la previsualización y los botones de acción
            document.getElementById('documentPreview').style.display = 'block';
            if (type === 'invoice') {
                document.getElementById('downloadBtnInvoice').style.display = 'inline-block';
                document.getElementById('newInvoiceBtn').style.display = 'inline-block';
            } else {
                document.getElementById('downloadBtnQuote').style.display = 'inline-block';
                document.getElementById('newQuoteBtn').style.display = 'inline-block';
                document.getElementById('convertBtnQuote').style.display = 'inline-block';
            }

            // --- Enviar datos a Google Sheets ---
            const dataToSend = {
                action: type === 'invoice' ? 'saveInvoice' : 'saveQuote',
                data: {
                    documentNumber: documentNumber,
                    clientName: clientName,
                    clientAddress: clientAddress,
                    clientPhone: clientPhone,
                    issueDate: issueDate,
                    dueDate: type === 'invoice' ? dueDate : '', // Solo si es factura
                    validityDays: type === 'quote' ? (parseInt(document.getElementById('validityDays').value) || 10) : '', // Solo si es cotización
                    totalAmount: totalAmount
                }
            };

            try {
                const response = await fetch(GOOGLE_SHEETS_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToSend)
                });

                const result = await response.json();
                if (result.status === 'success') {
                    console.log('Datos guardados en Google Sheets:', result.message);
                    alert(`¡${typeCapitalized} generada y guardada en Google Sheets con éxito!`);
                } else {
                    console.error('Error al guardar en Google Sheets:', result.message);
                    alert(`Error al guardar ${type} en Google Sheets: ${result.message}\nConsulte la consola del navegador para más detalles.`);
                }
            } catch (error) {
                console.error('Error de conexión con Google Sheets:', error);
                alert(`Error de conexión: No se pudo guardar ${type} en Google Sheets. Verifique su conexión o la URL del script.`);
            }
        }

        // Función para descargar el documento como PDF
        async function downloadPDF(type) {
            const { jsPDF } = window.jspdf;
            const element = document.getElementById('documentPreview');
            const typeName = type === 'invoice' ? 'Factura' : 'Cotizacion';
            const clientName = document.getElementById(`clientName${type.charAt(0).toUpperCase() + type.slice(1)}`).value.trim();
            const documentNum = document.getElementById('documentNumber').textContent;

            const filename = `${typeName}_${clientName.replace(/[^a-zA-Z0-9]/g, '')}_${documentNum}.pdf`;

            // Ocultar elementos de los botones de acción y navegación para que no aparezcan en el PDF
            const actionsDiv = document.querySelector('.actions');
            const navTabs = document.querySelector('.nav-tabs');
            const formSection = document.querySelector('.form-section');

            const originalActionsDisplay = actionsDiv.style.display;
            const originalNavTabsDisplay = navTabs.style.display;
            const originalFormSectionDisplay = formSection.style.display;

            actionsDiv.style.display = 'none';
            navTabs.style.display = 'none';
            formSection.style.display = 'none';

            // Ajustar el ancho del preview para que quepa en un PDF estándar (A4)
            const originalWidth = element.style.width;
            const originalPadding = element.style.padding;
            element.style.width = '794px'; // Ancho aproximado para A4 a 96dpi
            element.style.padding = '30px'; 


            try {
                // Generar canvas del documento con mayor escala para mejor calidad en PDF
                const canvas = await html2canvas(element, { scale: 2 }); 
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'pt', 'a4'); // 'p' para vertical, 'pt' para puntos, tamaño A4
                
                const imgWidth = 595.28; // Ancho A4 en puntos
                const pageHeight = 841.89; // Alto A4 en puntos
                const imgHeight = (canvas.height * imgWidth) / canvas.width; // Calcular alto proporcional
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // Añadir páginas adicionales si el contenido es más largo que una página A4
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                pdf.save(filename); // Guardar el PDF con el nombre generado
            } catch (error) {
                console.error("Error al generar el PDF:", error);
                alert("Hubo un error al generar el PDF. Por favor, inténtelo de nuevo.");
            } finally {
                // Restaurar los estilos originales después de generar el PDF
                actionsDiv.style.display = originalActionsDisplay;
                navTabs.style.display = originalNavTabsDisplay;
                formSection.style.display = originalFormSectionDisplay;
                element.style.width = originalWidth; 
                element.style.padding = originalPadding; 
            }
        }

        // Función para limpiar el formulario y preparar una nueva Factura/Cotización
        function newDocument(type) {
            const typeCapitalized = type.charAt(0).toUpperCase() + type.slice(1);
            document.getElementById(`clientName${typeCapitalized}`).value = '';
            document.getElementById(`clientAddress${typeCapitalized}`).value = '';
            document.getElementById(`clientPhone${typeCapitalized}`).value = '';
            initializeDates(); // Restablecer fechas a hoy y 30 días después
            
            document.getElementById(`logoInput${typeCapitalized}`).value = '';
            document.getElementById(`logoPreview${typeCapitalized}`).style.display = 'none';
            logoDataUrl[type] = null; // Reiniciar data URL del logo

            const servicesContainer = document.getElementById(`servicesContainer${typeCapitalized}`);
            servicesContainer.innerHTML = `
                <div class="service-item">
                    <input type="text" class="service-description" placeholder="Descripción del servicio">
                    <input type="number" class="service-price" placeholder="0.00" step="0.01" min="0">
                    <button class="btn btn-danger" onclick="removeService(this, '${type}')">Eliminar</button>
                </div>
            `;
            // Re-adjuntar event listener para el nuevo item de servicio
            servicesContainer.querySelector('.service-price').addEventListener('input', () => calculateTotal(type));

            calculateTotal(type); // Recalcular a 0.00
            
            // Ocultar previsualización y botones de acción
            document.getElementById('documentPreview').style.display = 'none';
            document.getElementById(`downloadBtn${typeCapitalized}`).style.display = 'none';
            document.getElementById(`new${typeCapitalized}Btn`).style.display = 'none';
            if (type === 'quote') {
                document.getElementById('convertBtnQuote').style.display = 'none';
            }
        }

        // Función para convertir una cotización a factura
        function convertToInvoice() {
            // Recuperar datos de la cotización actual
            const clientName = document.getElementById('clientNameQuote').value;
            const clientAddress = document.getElementById('clientAddressQuote').value;
            const clientPhone = document.getElementById('clientPhoneQuote').value;
            const issueDate = document.getElementById('issueDateQuote').value;
            const services = []; // Se usa para pasar los datos de los servicios para la visualización
            document.querySelectorAll('#servicesContainerQuote .service-item').forEach(item => {
                services.push({
                    description: item.querySelector('.service-description').value,
                    price: parseFloat(item.querySelector('.service-price').value) || 0
                });
            });
            const logo = logoDataUrl['quote'];

            // Cambiar a la pestaña de factura
            switchTab('invoice');

            // Llenar los campos de la factura con los datos de la cotización
            document.getElementById('clientNameInvoice').value = clientName;
            document.getElementById('clientAddressInvoice').value = clientAddress;
            document.getElementById('clientPhoneInvoice').value = clientPhone;
            document.getElementById('issueDateInvoice').value = issueDate;
            
            // Cargar logo si existe
            if (logo) {
                logoDataUrl['invoice'] = logo;
                document.getElementById('logoPreviewInvoice').src = logo;
                document.getElementById('logoPreviewInvoice').style.display = 'block';
            } else {
                document.getElementById('logoPreviewInvoice').style.display = 'none';
                logoDataUrl['invoice'] = null;
            }

            // Llenar servicios en la sección de factura
            const servicesContainerInvoice = document.getElementById('servicesContainerInvoice');
            servicesContainerInvoice.innerHTML = ''; // Limpiar servicios existentes
            services.forEach(service => {
                const serviceItem = document.createElement('div');
                serviceItem.className = 'service-item';
                serviceItem.innerHTML = `
                    <input type="text" class="service-description" placeholder="Descripción del servicio" value="${service.description}">
                    <input type="number" class="service-price" placeholder="0.00" step="0.01" min="0" value="${service.price.toFixed(2)}">
                    <button class="btn btn-danger" onclick="removeService(this, 'invoice')">Eliminar</button>
                `;
                servicesContainerInvoice.appendChild(serviceItem);
                // Adjuntar listener para el nuevo campo de precio
                serviceItem.querySelector('.service-price').addEventListener('input', () => calculateTotal('invoice'));
            });
            calculateTotal('invoice'); // Recalcular el total de la factura
            
            // Ocultar botones de cotización después de la conversión
            document.getElementById('downloadBtnQuote').style.display = 'none';
            document.getElementById('newQuoteBtn').style.display = 'none';
            document.getElementById('convertBtnQuote').style.display = 'none';
        }

        // Inicializar la aplicación cuando el DOM esté completamente cargado
        document.addEventListener('DOMContentLoaded', function() {
            initializeDates(); // Establecer fechas predeterminadas
            setupLogoHandler('invoice'); // Configurar carga de logo para factura
            setupLogoHandler('quote');   // Configurar carga de logo para cotización

            // Adjuntar event listeners a los campos de precio existentes para calcular el total
            document.querySelectorAll('#servicesContainerInvoice .service-price').forEach(input => {
                input.addEventListener('input', () => calculateTotal('invoice'));
            });
            document.querySelectorAll('#servicesContainerQuote .service-price').forEach(input => {
                input.addEventListener('input', () => calculateTotal('quote'));
            });
            calculateTotal('invoice'); // Calcular total inicial para factura
            calculateTotal('quote');   // Calcular total inicial para cotización

            // Adjuntar event listeners para formatear números de teléfono
            const phoneInputInvoice = document.getElementById('clientPhoneInvoice');
            phoneInputInvoice.addEventListener('input', function() {
                formatPhoneNumber(this);
            });

            const phoneInputQuote = document.getElementById('clientPhoneQuote');
            phoneInputQuote.addEventListener('input', function() {
                formatPhoneNumber(this);
            });
        });

    </script>
</body>
</html>